<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Planner Semanal - Everton</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background-color: #ffffff;
        }
        th, td {
            border: 1px solid #dddddd;
            padding: 8px 10px;
            text-align: center;
        }
        th {
            background-color: #eeeeee;
        }
        .completed {
            text-decoration: line-through;
            color: #666;
        }
        .day-header {
            text-align: left;
            font-weight: bold;
            background-color: #e0f2f1;
        }
        .controls {
            margin-bottom: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        button {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .reset-btn {
            background-color: #ffcdd2;
        }
        .reload-btn {
            background-color: #c5e1a5;
        }
    </style>
</head>
<body>
<h1>Planner Semanal</h1>

<div class="controls">
    <button class="reload-btn" onclick="loadSchedule()">Recarregar</button>
    <button class="reset-btn" onclick="resetChecks()">Resetar Checks</button>
</div>

<table id="schedule-table">
    <thead>
    <tr>
        <th>Dia</th>
        <th>Horário</th>
        <th>Atividade</th>
        <th>✔</th>
    </tr>
    </thead>
    <tbody>
    <!-- preenchido via JS -->
    </tbody>
</table>

<script>
    const dayOrder = [
        "SEGUNDA", "TERCA", "QUARTA", "QUINTA", "SEXTA", "SABADO", "DOMINGO"
    ];

    function groupByDay(entries) {
        const map = {};
        entries.forEach(e => {
            if (!map[e.dayOfWeek]) {
                map[e.dayOfWeek] = [];
            }
            map[e.dayOfWeek].push(e);
        });
        // ordenar por faixa de horário só de leve (alfabética)
        Object.keys(map).forEach(day => {
            map[day].sort((a, b) => a.timeRange.localeCompare(b.timeRange));
        });
        return map;
    }

    async function loadSchedule() {
        const tbody = document.querySelector("#schedule-table tbody");
        tbody.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";

        const resp = await fetch("/api/schedule");
        const data = await resp.json();

        const grouped = groupByDay(data);
        tbody.innerHTML = "";

        dayOrder.forEach(day => {
            const entries = grouped[day] || [];
            if (entries.length === 0) {
                return;
            }
            entries.forEach((entry, index) => {
                const tr = document.createElement("tr");
                if (index === 0) {
                    const tdDay = document.createElement("td");
                    tdDay.className = "day-header";
                    tdDay.textContent = day;
                    tdDay.rowSpan = entries.length;
                    tr.appendChild(tdDay);
                }

                const tdTime = document.createElement("td");
                tdTime.textContent = entry.timeRange;

                const tdDesc = document.createElement("td");
                tdDesc.textContent = entry.description;
                if (entry.completed) {
                    tdDesc.classList.add("completed");
                }

                const tdCheck = document.createElement("td");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.checked = entry.completed;
                checkbox.addEventListener("change", () => toggleCheck(entry.id));
                tdCheck.appendChild(checkbox);

                tr.appendChild(tdTime);
                tr.appendChild(tdDesc);
                tr.appendChild(tdCheck);

                tbody.appendChild(tr);
            });
        });
    }

    async function toggleCheck(id) {
        await fetch(`/api/schedule/${id}/toggle`, {
            method: "PATCH"
        });
        await loadSchedule();
    }

    async function resetChecks() {
        await fetch("/api/schedule/reset", {
            method: "POST"
        });
        await loadSchedule();
    }

    // carrega na inicialização
    loadSchedule();
</script>
</body>
</html>
